# Puppet CI Resources

classes:
  - nsidc_jenkins

# Jenkins Plugins
nsidc_jenkins::plugins:
  git: {}
  git-client: {}
  git-parameter: {}
  scm-api: {}
  credentials: {}
  ssh-credentials: {}
  greenballs: {}
  jobConfigHistory: {}
  mailer: {}
  instant-messaging: {}
  jabber: {}
  ansicolor: {}

# Jenkins Jobs
nsidc_jenkins::jobs:
  "%{hiera('project')}_1_Checkout_Project":
    git:
      repo: "%{hiera('gitrepo')}"
      # branches: "*/NAME-OF-FEATURE-BRANCH"
      # checkout_local: "NAME-OF-FEATURE-BRANCH"
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/master
    trigger_job: "%{hiera('project')}_2_Configure_System"
  "%{hiera('project')}_2_Configure_System":
    command: |
      cd puppet
      librarian-puppet clean
      librarian-puppet install
      cd -
     
      # with the --detailed-exitcodes flag, exit code of 2 means that changes
      # were made, i.e., puppet did stuff to your system like it's supposed to
      #
      # https://docs.puppetlabs.com/references/3.4.latest/man/agent.html
      bash -c "sudo puppet apply --environment=ci --debug --verbose --detailed-exitcodes --modulepath=./puppet/modules:/vagrant-local-jenkins --hiera_config=./puppet/hiera.yaml ./puppet/site.pp; puppet_exit=\$?; echo puppet exit code = \$puppet_exit; if [ \"\$puppet_exit\" = \"2\" ]; then exit 0; else exit \$puppet_exit; fi" 

    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/master
    trigger_job: "%{hiera('project')}_3_Check_Syntax"
  "%{hiera('project')}_3_Check_Syntax":
    command: rake lint
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/master
    trigger_job: "%{hiera('project')}_4_Run_Unit_Tests"
  "%{hiera('project')}_4_Run_Unit_Tests":
    command: rake spec:unit
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/master
    trigger_job: "%{hiera('project')}_5_Run_Acceptance_Tests"
  "%{hiera('project')}_5_Run_Acceptance_Tests":
    command: |
      set +e; vagrant nsidc hijack --env=integration; set -e
      rake spec:acceptance
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/master

  "%{hiera('project')}_Release_1_Bump_Version_and_Tag":
    git:
      repo: "%{hiera('gitrepo')}"
      poll_scm: false
    parameters:
      - type: string
        name: branch
        description: git branch to checkout and tag
        default: master
      - type: choice
        name: version_type
        choices:
          - patch
          - minor
          - major
    command: |
      git checkout $branch
      rake bump[$version_type]
      git push origin master --tags
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/release
    trigger_job: "%{hiera('project')}_Release_2_Publish_Latest"

  # This job is expecting that you have pushed up a branch called
  # latest to the repo.  The latest branch can be referenced with the
  # :ref => 'latest' option when calling the module in the consumer's Puppetfile.
  "%{hiera('project')}_Release_2_Publish_Latest":
    command: |
      git fetch origin latest
      git checkout latest
      git pull
      git merge master
      git push origin latest
    workspace: /var/lib/jenkins/workspaces/%{hiera('project')}/release
